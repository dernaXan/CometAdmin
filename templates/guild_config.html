{% extends 'base.html' %}

{% block head %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
{% endblock %}

{% block content %}
  <h1>Einstellungen für Server {{ guild_id }}</h1>

  <form method="POST" action="/config/{{ guild_id }}">
    <div class="section">
      <h3>Moderation</h3>

      <label for="modrole">Modrolle:</label>
      <select id="modrole" name="modrole" required>
        <option value="" disabled selected>Bitte auswählen</option>
        {% for role in roles %}
          <option value="{{ role.id }}">{{ role.name }}</option>
        {% endfor %}
      </select>

      <label for="modchat">Modchat:</label>
      <select id="modchat" name="modchat" required>
        <option value="" disabled selected>Bitte auswählen</option>
        {% for channel in channels %}
          <option value="{{ channel.id }}">{{ channel.name }}</option>
        {% endfor %}
      </select>

      <label for="badwords">Badwords Filter:</label>
      <textarea id="badwords" name="badwords" placeholder="Wörter eintippen und mit Komma trennen"></textarea>
    </div>

    <div class="section">
      <h3>Punktesystem</h3>

      <label for="maxminuspoints">Maximale Minus-Punkte</label>
      <input type="number" name="maxminuspoints" id="maxminuspoints" max="-1" step="1" />

      <label for="minuspointsaction">Strafe:</label>
      <select id="minuspointsaction" name="minuspointsaction">
        <option value="0">Nichts</option>
        <option value="1">Kick</option>
        <option value="2">Bann</option>
      </select>
    </div>

    <div class="section">
      <h3>Shop</h3>

      <label for="itemSelect">Shopangebote verwalten</label>
      <select id="itemSelect">
        <option value="" disabled selected>Item auswählen</option>
        {% for item in shop_items %}
          <option value="{{ loop.index0 }}">{{ item.name }}</option>
        {% endfor %}
      </select>

      <div id="itemContainer"></div>

      <button type="button" id="addItemBtn">Neues Item</button>
    </div>
  </form>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const textarea = document.getElementById('badwords');

    // Initialisiere Tagify
    const tagify = new Tagify(textarea, {
      delimiters: ",",
      pattern: /[^,]+/,
      dropdown: { enabled: 0 },
      enforceWhitelist: false,
      maxTags: 100
    });

    textarea.addEventListener('change', () => {
      console.log("Werte:", textarea.value);
    });

    const shopItems = {{ shop_items | tojson }};
    let itemIndex = shopItems.length;

    const itemSelect = document.getElementById('itemSelect');
    const itemContainer = document.getElementById('itemContainer');
    const addItemBtn = document.getElementById('addItemBtn');

    function renderItem(item, index) {
      const div = document.createElement('div');
      div.classList.add('shop-item');
      div.dataset.itemIndex = index;

      div.innerHTML = `
        <hr>
        <strong>Item: ${item.name || 'Neues Item'}</strong>
        <input type="hidden" name="items[${index}][id]" value="${item.id || ''}">
        <label>Name:</label>
        <input type="text" name="items[${index}][name]" value="${item.name || ''}">
        <label>Preis:</label>
        <input type="number" name="items[${index}][price]" value="${item.price || 0}">
        <label>Stock:</label>
        <input type="number" name="items[${index}][stock]" value="${item.stock !== undefined ? item.stock : -1}">
        <button type="button" onclick="removeItem(this)">Löschen</button>
      `;
      itemContainer.appendChild(div);
    }

    // Vorhandene Items rendern
    shopItems.forEach((item, i) => renderItem(item, i));

    // Auswahl im Dropdown scrollt zum Item
    itemSelect.addEventListener('change', function () {
      const selectedIndex = this.value;
      const itemDiv = [...itemContainer.children].find(child => {
        return child.dataset.itemIndex === selectedIndex;
      });

      if (itemDiv) {
        itemDiv.scrollIntoView({ behavior: 'smooth' });
        itemDiv.style.border = '2px solid limegreen';
        setTimeout(() => itemDiv.style.border = '', 1500);
      }
    });

    // Neues Item hinzufügen
    addItemBtn.addEventListener('click', () => {
      renderItem({}, itemIndex);
      itemIndex++;
    });

    // Item entfernen
    window.removeItem = function (button) {
      const itemDiv = button.closest('.shop-item');
      if (itemDiv) itemDiv.remove();
    };
  });
</script>
{% endblock %}
